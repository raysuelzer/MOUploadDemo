using System;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using MushroomObserver.APIService.Models;
using MushroomObserver.APIService.Services;

namespace MushroomObserver.Tests
{
    [TestClass]
    public class XmlSerializationTests
    {
        [TestMethod]
        public void CanSerializeCreateObservationResponse()
        {
            // Arrange
            var rawXml =
                "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n" +
                "<response xmlns=\"http://localhost:3000/response.xsd\">\n  " +
                "<version type=\"string\" content_type=\"text/plain\">1.0</version>\n  " +
                "<run_date type=\"date-time\" format=\"YYYY-MM-DD HH:MM:SS\">2016-01-18 00:31:19</run_date>\n  " +
                "<user id=\"3534\" url=\"http://localhost:3000/observer/show_user/3534\" type=\"user\"/>\n<results number=\"2\">\n  " +
                "<result id=\"211847\" url=\"http://localhost:3000/observer/show_observation/211847\" type=\"observation\"/>\n" +
                "<result id=\"211848\" url=\"http://localhost:3000/observer/show_observation/211848\" type=\"observation\"/>\n" +
                "</results>\n  " +
                "<run_time type=\"float\" units=\"seconds\">0.6160</run_time>\n</response>\n";


            //Act
            var result = rawXml.ParseXML<XMLResponseModels.ApiResponse>();

            //Assert
            Assert.AreEqual(1.0m, result.Version.Value);
            Assert.AreEqual(2, result.Results.Items.Length);
            Assert.AreEqual(211847, result.Results.Items[0].Id);
        }


        [TestMethod]
        public void CanSerializeErrorResponse()
        {
           var rawXml = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<response xmlns=\"http://localhost:3000/response.xsd\">\n  <version type=\"string\" content_type=\"text/plain\">1.0</version>\n  <run_date type=\"date-time\" format=\"YYYY-MM-DD HH:MM:SS\">2016-01-18 01:28:59</run_date>\n  <user id=\"3534\" url=\"http://localhost:3000/observer/show_user/3534\" type=\"user\"/>\n  <errors number=\"1\">\n    <error id=\"1\">\n      <code>API::ObjectNotFoundByString</code>\n      <details>Name \"Lactarius circellatus Fr.\" does not exist, or someone has deleted it.</details>\n      <fatal>true</fatal>\n      <trace>/vagrant/mushroom-observer/app/classes/api/parse_name.rb:25:in `find_name'\n/vagrant/mushroom-observer/app/classes/api/parse_name.rb:10:in `parse_name'\n/vagrant/mushroom-observer/app/classes/api/observation_api.rb:62:in `create_params'\n/vagrant/mushroom-observer/app/classes/api/model_api.rb:59:in `build_object'\n/vagrant/mushroom-observer/app/classes/api/model_api.rb:12:in `post'\n/vagrant/mushroom-observer/app/classes/api/base.rb:88:in `process_request'\n/vagrant/mushroom-observer/app/classes/api/base.rb:27:in `execute'\n/vagrant/mushroom-observer/app/controllers/api_controller.rb:103:in `render_api_results'\n/vagrant/mushroom-observer/app/controllers/api_controller.rb:99:in `rest_query'\n/vagrant/mushroom-observer/app/controllers/api_controller.rb:42:in `observations'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/actionpack-4.2.5/lib/action_controller/metal/implicit_render.rb:4:in `send_action'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/actionpack-4.2.5/lib/abstract_controller/base.rb:198:in `process_action'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/actionpack-4.2.5/lib/action_controller/metal/rendering.rb:10:in `process_action'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/actionpack-4.2.5/lib/abstract_controller/callbacks.rb:20:in `block in process_action'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/activesupport-4.2.5/lib/active_support/callbacks.rb:117:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/activesupport-4.2.5/lib/active_support/callbacks.rb:117:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/activesupport-4.2.5/lib/active_support/callbacks.rb:555:in `block (2 levels) in compile'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/activesupport-4.2.5/lib/active_support/callbacks.rb:505:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/activesupport-4.2.5/lib/active_support/callbacks.rb:505:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/activesupport-4.2.5/lib/active_support/callbacks.rb:498:in `block (2 levels) in around'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/activesupport-4.2.5/lib/active_support/callbacks.rb:313:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/activesupport-4.2.5/lib/active_support/callbacks.rb:313:in `block (2 levels) in halting'\n/vagrant/mushroom-observer/app/controllers/application_controller.rb:214:in `catch_errors'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/activesupport-4.2.5/lib/active_support/callbacks.rb:432:in `block in make_lambda'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/activesupport-4.2.5/lib/active_support/callbacks.rb:312:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/activesupport-4.2.5/lib/active_support/callbacks.rb:312:in `block in halting'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/activesupport-4.2.5/lib/active_support/callbacks.rb:497:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/activesupport-4.2.5/lib/active_support/callbacks.rb:497:in `block in around'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/activesupport-4.2.5/lib/active_support/callbacks.rb:505:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/activesupport-4.2.5/lib/active_support/callbacks.rb:505:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/activesupport-4.2.5/lib/active_support/callbacks.rb:92:in `__run_callbacks__'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/activesupport-4.2.5/lib/active_support/callbacks.rb:778:in `_run_process_action_callbacks'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/activesupport-4.2.5/lib/active_support/callbacks.rb:81:in `run_callbacks'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/actionpack-4.2.5/lib/abstract_controller/callbacks.rb:19:in `process_action'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/actionpack-4.2.5/lib/action_controller/metal/rescue.rb:29:in `process_action'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/actionpack-4.2.5/lib/action_controller/metal/instrumentation.rb:32:in `block in process_action'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/activesupport-4.2.5/lib/active_support/notifications.rb:164:in `block in instrument'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/activesupport-4.2.5/lib/active_support/notifications/instrumenter.rb:20:in `instrument'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/activesupport-4.2.5/lib/active_support/notifications.rb:164:in `instrument'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/actionpack-4.2.5/lib/action_controller/metal/instrumentation.rb:30:in `process_action'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/actionpack-4.2.5/lib/action_controller/metal/params_wrapper.rb:250:in `process_action'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/activerecord-4.2.5/lib/active_record/railties/controller_runtime.rb:18:in `process_action'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/actionpack-4.2.5/lib/abstract_controller/base.rb:137:in `process'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/actionview-4.2.5/lib/action_view/rendering.rb:30:in `process'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/actionpack-4.2.5/lib/action_controller/metal.rb:196:in `dispatch'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/actionpack-4.2.5/lib/action_controller/metal/rack_delegation.rb:13:in `dispatch'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/actionpack-4.2.5/lib/action_controller/metal.rb:237:in `block in action'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/actionpack-4.2.5/lib/action_dispatch/routing/route_set.rb:76:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/actionpack-4.2.5/lib/action_dispatch/routing/route_set.rb:76:in `dispatch'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/actionpack-4.2.5/lib/action_dispatch/routing/route_set.rb:45:in `serve'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/actionpack-4.2.5/lib/action_dispatch/journey/router.rb:43:in `block in serve'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/actionpack-4.2.5/lib/action_dispatch/journey/router.rb:30:in `each'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/actionpack-4.2.5/lib/action_dispatch/journey/router.rb:30:in `serve'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/actionpack-4.2.5/lib/action_dispatch/routing/route_set.rb:817:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/rack-1.6.4/lib/rack/etag.rb:24:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/rack-1.6.4/lib/rack/conditionalget.rb:38:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/rack-1.6.4/lib/rack/head.rb:13:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/actionpack-4.2.5/lib/action_dispatch/middleware/params_parser.rb:27:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/actionpack-4.2.5/lib/action_dispatch/middleware/flash.rb:260:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/rack-1.6.4/lib/rack/session/abstract/id.rb:225:in `context'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/rack-1.6.4/lib/rack/session/abstract/id.rb:220:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/actionpack-4.2.5/lib/action_dispatch/middleware/cookies.rb:560:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/activerecord-4.2.5/lib/active_record/query_cache.rb:36:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/activerecord-4.2.5/lib/active_record/connection_adapters/abstract/connection_pool.rb:653:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/activerecord-4.2.5/lib/active_record/migration.rb:377:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/actionpack-4.2.5/lib/action_dispatch/middleware/callbacks.rb:29:in `block in call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/activesupport-4.2.5/lib/active_support/callbacks.rb:88:in `__run_callbacks__'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/activesupport-4.2.5/lib/active_support/callbacks.rb:778:in `_run_call_callbacks'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/activesupport-4.2.5/lib/active_support/callbacks.rb:81:in `run_callbacks'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/actionpack-4.2.5/lib/action_dispatch/middleware/callbacks.rb:27:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/actionpack-4.2.5/lib/action_dispatch/middleware/reloader.rb:73:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/actionpack-4.2.5/lib/action_dispatch/middleware/remote_ip.rb:78:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/actionpack-4.2.5/lib/action_dispatch/middleware/debug_exceptions.rb:17:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/web-console-2.2.1/lib/web_console/middleware.rb:39:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/actionpack-4.2.5/lib/action_dispatch/middleware/show_exceptions.rb:30:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/railties-4.2.5/lib/rails/rack/logger.rb:38:in `call_app'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/railties-4.2.5/lib/rails/rack/logger.rb:20:in `block in call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/activesupport-4.2.5/lib/active_support/tagged_logging.rb:68:in `block in tagged'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/activesupport-4.2.5/lib/active_support/tagged_logging.rb:26:in `tagged'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/activesupport-4.2.5/lib/active_support/tagged_logging.rb:68:in `tagged'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/railties-4.2.5/lib/rails/rack/logger.rb:20:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/actionpack-4.2.5/lib/action_dispatch/middleware/request_id.rb:21:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/rack-1.6.4/lib/rack/methodoverride.rb:22:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/rack-1.6.4/lib/rack/runtime.rb:18:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/activesupport-4.2.5/lib/active_support/cache/strategy/local_cache_middleware.rb:28:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/rack-1.6.4/lib/rack/lock.rb:17:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/actionpack-4.2.5/lib/action_dispatch/middleware/static.rb:116:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/rack-1.6.4/lib/rack/sendfile.rb:113:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/railties-4.2.5/lib/rails/engine.rb:518:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/railties-4.2.5/lib/rails/application.rb:165:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/rack-1.6.4/lib/rack/lock.rb:17:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/rack-1.6.4/lib/rack/content_length.rb:15:in `call'\n/home/vagrant/.rvm/gems/ruby-2.2.3/gems/rack-1.6.4/lib/rack/handler/webrick.rb:88:in `service'\n/home/vagrant/.rvm/rubies/ruby-2.2.3/lib/ruby/2.2.0/webrick/httpserver.rb:138:in `service'\n/home/vagrant/.rvm/rubies/ruby-2.2.3/lib/ruby/2.2.0/webrick/httpserver.rb:94:in `run'\n/home/vagrant/.rvm/rubies/ruby-2.2.3/lib/ruby/2.2.0/webrick/server.rb:294:in `block in start_thread'</trace>\n    </error>\n  </errors>\n  <run_time type=\"float\" units=\"seconds\">0.0977</run_time>\n</response>\n";

            var result = rawXml.ParseXML<XMLResponseModels.ApiResponse>();

            Assert.IsNull(result.Results);
            Assert.IsNotNull(result.Errors);
            Assert.AreEqual(@"Name ""Lactarius circellatus Fr."" does not exist, or someone has deleted it.", result.Errors.Items[0].Details);
        }


        
        
    }
}
